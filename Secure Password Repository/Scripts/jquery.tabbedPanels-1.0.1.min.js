(function ($) {
    'use strict';
    $.fn.tabbedPanels = function (options) {
        var settings, strHeading, strHeadings, strFirstClass, strTabbedContentID, strClassNavContainer, strClassTabbedPanel, strRemoveClassTabbedPanel;

        settings = $.extend({
            eleTabText: 'h2:first',
            hideEleTabText: true,
            classNavContainer: '',
            classTabbedPanel: '',
            removeClassTabbedPanel: ''
        }, options);

        strHeading = '';
        strHeadings = '';
        strFirstClass = '';
        strTabbedContentID = this.attr('id');

        strClassNavContainer = settings.classNavContainer.replace(/,/, ' ');

        if (strClassNavContainer === '') {
            strClassNavContainer = 'tabbed-content-nav';
        } else {
            strClassNavContainer += ' tabbed-content-nav';
        }

        strClassTabbedPanel = settings.classTabbedPanel.replace(/,/, ' ');

        if (strClassTabbedPanel === '') {
            strClassTabbedPanel = 'tabbed-content-panel';
        } else {
            strClassTabbedPanel += ' tabbed-content-panel';
        }

        strRemoveClassTabbedPanel = settings.removeClassTabbedPanel.replace(/,/, ' ');

        this.addClass('tabbed-content').each(function () {
            strHeadings = '';

            $(this).children().not('.ignore').each(function (i) {
                $(this).attr('id', strTabbedContentID + '_' + (i + 1) + '_panel').addClass(strClassTabbedPanel);

                if(i>0)
                    $(this).attr('id', strTabbedContentID + '_' + (i + 1) + '_panel').hide();

                if (strRemoveClassTabbedPanel !== '') {
                    $(this).removeClass(strRemoveClassTabbedPanel);
                }

                if (settings.hideEleTabText) {
                    $(this).find(settings.eleTabText).css('display', 'none');
                }

                if (i === 0) {
                    strFirstClass = ' first selected';
                } else {
                    strFirstClass = '';
                }

                strHeading = $(this).find(settings.eleTabText).text();

                if (strHeading === '') {
                    strHeading = 'Panel ' + (i + 1);
                }

                strHeadings += '<li class="ib"><a href="#' + strTabbedContentID + '_' + (i + 1) + '_panel" id="' + strTabbedContentID + '_' + (i + 1) + '" class="link' + strFirstClass + ' ib" onclick="tabClick(\'' + strHeading + '\');return false;">' + strHeading + '</a></li>';
            });

            if (strHeadings !== '') {
                $(this).prepend('<ul id="' + strTabbedContentID + 'nav">' + strHeadings + '</ul>');

                $('#' + strTabbedContentID + 'nav').addClass(strClassNavContainer).children('a').first().addClass('selected');
            }
        });

        $('.tabbed-content-nav').find('a.link').click(function () {
            var $objTarget, strTabbedContentID, $objChildTabs;

            $objTarget = $('#' + $(this).attr('id') + '_panel');

            if ($objTarget.css('display') === 'none') {

                strTabbedContentID = $(this).parents('.tabbed-content').attr('id');

                $('#' + strTabbedContentID).find('.tabbed-content-nav a.link').removeClass('selected');

                $(this).addClass('selected');
                $(this).blur();


                $objChildTabs = $objTarget.find('.tabbed-content-nav a.first');
                if ($objChildTabs.length > 0) {
                    $objChildTabs.addClass('selected');
                    $objChildTabs.parent().parent().parent().parent().find('.tabbed-content .panel').hide();
                    $objChildTabs.parent().parent().parent().parent().find('.tabbed-content .panel.first').show();
                }

                $('#' + strTabbedContentID).children().not('.tabbed-content-nav').hide();
                $objTarget.fadeIn();
            }
        });

        function getQSHash() {
            var strQueryString, strAnchorHash;

            strQueryString = document.location.toString();

            if (strQueryString.match('#')) {
                strAnchorHash = '#' + strQueryString.split('#')[1];

                if (strAnchorHash !== '') {
                    return strAnchorHash;
                }
            }

        }

        function displayTabbedPanelByHash() {
            var strHash, strID;

            strHash = getQSHash();

            if (strHash) {
                if ($(strHash).parents('div.tabbed-content').length) { // The hash exists within .tabbed-content panel
                    if ($(strHash).hasClass('tabbed-content-panel')) {
                        strID = $(strHash).attr('id');
                    } else {
                        strID = $(strHash).parents('div.tabbed-content-panel').attr('id'); // retrieve ID of #tabbedpanels panel
                    }

                    if (strID) {
                        if (strID.match('_panel')) { // double check that we have an #tabbedpanels panel
                            strID = '#' + strID.replace('_panel', ''); // add preceding '#' to and remove '_panel' from id to find name of appropriate #tabbedpanels panel anchor
                            $('a' + strID).trigger('click'); // fake a click on this panel
                        }
                    }
                }

            }
        }

        displayTabbedPanelByHash();

        return this;
    };
}(jQuery));
